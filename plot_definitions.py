from table_info import BiomTable
import pandas as pd


def is_ms(sample_id):
    if "BLANK" in sample_id:
        return False
    
    ss = sample_id.split('.')
    if ss[0] == "11326":
        ss = ss[1:]
        
    if len(ss) < 3:
        return False
    return ss[1].endswith("1")

def is_new_sample_closure(new_samples_set):
    return lambda x: x in new_samples_set

def build_new_samples_set(new_files):
    all_dfs = []
    for biom_table in new_files:
        bt = BiomTable(biom_table)
        df = bt.load_dataframe()
        all_dfs.append(df)

    df = pd.concat(all_dfs).fillna(0)
    return set(list(df.index))

imsms_plots={
    "Acetivibrio":["G001461035", "G000179595", "G000179595"],
    "Acetobacter":["G001917135", "G000434135", "G000434295"],
    "Acidaminococcus": ["G000230275", "G900115425", "G000437815"],
    "Acinetobacter": ["G000980495", "G000433235", "G000368825"],
    "Actinomyces": ["G000296505", "G001807435", "G000239695"],
    "Akkermansia": ["G000437075", "G001917295", "G001580195"],
    "Alistipes": ["G000154465", "G000210575", "G000265365"],
    "Alloprevotella": ["G000159995", "G000318095", "G000234115"],
    "Anaerococcus": ["G000311745", "G000191725", "G000156575"],
    "Anaerostipes": ["G000332875", "G000154305", "G000432215"],
    "Anaerotruncus": ["G000154565", "G000433975", "G000437015"],
    "Arcanobacterium": ["G001055535", "G000092365", "G000758825"],
    "Atopobium": ["G001562845", "G001552785", "G900105895"],
    "Azospirillum":["G000436195", "G001917125", "G001305595"],
    "Bacillus":["G000740655", "G001183965", "G000437335"],
    "Bacteroides":["G000154205", "G000012825", "G000436135"],
    "Barnesiella":["G000296465", "G000512915", "G000512915"],
    "Bifidobacterium":["G000010425", "G000007525", "G000165905"],
    "Blautia":["G001404455", "G000466565", "G001915695"],
    "Brachyspira":["G000431315", "G000325665", "G001676785"],
    "Brevibacterium":["G000178455", "G000285915", "G001729525"],
    "Butyricicoccus":["G001643385", "G000398925", "G000701665"],
    "Butyricimonas":["G000519105", "G001915615", "G900091675"],
    "Butyrivibrio":["G000156015", "G001915735", "G000432395"],
    "Campylobacter":["G000017585", "G001190755", "G000583775"],
    "Catenibacterium":["G000437715", "G000173795", "G000173795"],
    "Cellulomonas":["G000767175", "G001057055", "G001429255"],
    "Chryseobacterium":["G001021975", "G001507325", "G000735695"],
    "Citrobacter":["G000648515", "G001558935", "G001558935"],
    "Cloacibacillus":["G000585335", "G001701045", "G001701045"],
    "Clostridioides":["G000450985", "G000009205", "G000687955"],
    "Clostridium":["G000435355", "G000432475", "G000435055"],
    "Collinsella":["G001405375", "G000156175", "G000821265"],
    "Comamonas":["G001294445", "G000739375", "G000935165"],
    "Coprobacillus":["G000269565", "G000433255", "G000437235"],
    "Coprococcus":["G000155875", "G000436635", "G000154425"],
    "Coraliomargarita":["G000438015", "G000025905", "G000025905"],
    "Corynebacterium":["G000173655", "G001054195", "G000411375"],
    "Cryptobacterium":["G000435475", "G000023845", "G000023845"],
    "Cutibacterium":["G000367205", "G000463665", "G000008345"],
    "Desulfovibrio":["G900116045", "G001553605", "G000420465"],
    "Dialister":["G000435155", "G000160055", "G000434475"],
    "Dorea":["G000154065", "G000169235", "G001916345"],
    "Eggerthella":["G000024265", "G001915265", "G000270285"],
    "Enorma":["G000311845", "G000321165", "G000321165"],
    "Enterobacter":["G000025565", "G000164865", "G000016325"],
    "Enterococcus":["G000007785", "G000648175", "G000648015"],
    "Erysipelatoclostridium":["G000154485", "G000371425", "G000154805"],
    "Escherichia":["G000183345", "G000026325", "G000299455"],
    "Eubacterium":["G000173975", "G000146185", "G000432435"],
    "Facklamia":["G000301035", "G000301055", "G000245795"],
    "Faecalibacterium":["G000162015", "G001916495", "G000434675"],
    "Faecalitalea":["G000210615", "G000469305", "G000469305"],
    "Fibrobacter":["G900142485", "G900129735", "G900142495"],
    "Fusobacterium":["G000158195", "G000158275", "G001854465"],
    "Gardnerella":["G000025205", "G000159155", "G000414525"],
    "Haemophilus":["G001055885", "G000261285", "G001679325"],
    "Heliobacterium":["G000980455", "G000019165", "G000019165"],
    "Holdemania":["G000157995", "G900120005", "G000327285"],
    "Hungatella":["G000160095", "G000235505", "G000235505"],
    "Intestinimonas":["G001244995", "G001454945", "G001454945"],
    "Kallipyga":["G000311985", "G001286805", "G001286805"],
    "Klebsiella":["G000240185", "G001022195", "G000215745"],
    "Kluyvera":["G001022135", "G001571285", "G000735365"],
    "Lachnoanaerobaculum":["G000296385", "G000185385", "G000185385"],
    "Lachnoclostridium":["G000371705", "G000189595", "G001311035"],
    "Lactobacillus":["G000016825", "G000191545", "G000091765"],
    "Lactococcus":["G000006865", "G000269945", "G000981525"],
    "Lawsonella":["G001281505", "G001293125", "G001293125"],
    "Leuconostoc":["G001698145", "G000026405", "G000196855"],
    "Megamonas":["G000245775", "G000423385", "G000423385"],
    "Megasphaera":["G000455225", "G000283495", "G000177555"],
    "Methanobrevibacter":["G000437055", "G000016525", "G000190095"],
    "Methanomassiliicoccus":["G000404225", "G000308215", "G000308215"],
    "Methanosphaera":["G000012545", "G001729395", "G001729395"],
    "Mitsuokella":["G000155955", "G000469545", "G000469545"],
    "Mycoplasma":["G000433455", "G000433475", "G000433475"],
    "Odoribacter":["G000190535", "G000243215", "G000433935"],
    "Oscillibacter":["G000469445", "G000765235", "G001916835"],
    "Oxalobacter":["G000158495", "G000158475", "G000158475"],
    "Pantoea":["G000784965", "G001709315", "G000759475"],
    "Parabacteroides":["G000012845", "G000433955", "G000307375"],
    "Paraprevotella":["G000436895", "G000205165", "G000205165"],
    "Parasutterella":["G000205025", "G000431455", "G000431455"],
    "Pediococcus":["G001767275", "G000014505", "G001611135"],
    "Peptoniphilus":["G000378725", "G000311825", "G000183565"],
    "Peptostreptococcus":["G000381525", "G000431415", "G000147675"],
    "Phascolarctobacterium":["G000436295", "G000188175", "G000436095"],
    "Pontibacillus":["G000775615", "G000770675", "G000775595"],
    "Porphyromonas":["G000372405", "G000375645", "G000768955"],
    "Prevotella":["G000157935", "G001275135", "G000431915"],
    "Pseudomonas":["G000007565", "G001543265", "G000455385"],
    "Rhodospirillum":["G000980655", "G000013085", "G000013085"],
    "Riemerella":["G000374405", "G000252855", "G000252855"],
    "Roseburia":["G001405615", "G000156535", "G000174195"],
    "Ruminiclostridium":["G000382085", "G000154345", "G000158655"],
    "Ruminococcus":["G001917065", "G001312505", "G000432115"],
    "Sanguibacteroides":["G000832075", "G000832085", "G000832085"],
    "Shigella":["G000006925", "G000012005", "G000012005"],
    "Slackia":["G000296445", "G000162875", "G000023885"],
    "Solobacterium":["G000425005", "G000186945", "G000186945"],
    "Staphylococcus":["G000433035", "G001456215", "G000009865"],
    "Streptococcus":["G000253395", "G000785515", "G000463505"],
    "Subdoligranulum":["G000437915", "G000157955", "G000157955"],
    "Succinatimonas":["G000431835", "G000188195", "G000188195"],
    "Succinivibrio":["G001940885", "G900116345", "G000702045"],
    "Sulfolobus":["G001560465", "G000175555", "G000175555"],
    "Sutterella":["G000297775", "G000434855", "G000437635"],
    "Synergistes":["G000238615", "G001941205", "G000712295"],
    "Turicibacter":["G000178255", "G001543345", "G001406535"],
    "Tyzzerella":["G000156035", "G900142265", "G900142265"],
    "Varibaculum":["G000508625", "G900106855", "G001553285"],
    "Veillonella":["G000286635", "G000431435", "G001553335"],
    "Weissella":["G001308145", "G000239955", "G000160575"],
    "Yersinia":["G000009065", "G000168835", "G000324905"]
}

imsms_qualitative_class = {
    "Acetivibrio": ["NO", "only 1 species in samples"],
    "Acetobacter": ["YES", ""],
    "Acidaminococcus": ["YES", ""],
    "Acinetobacter": ["YES", ""],
    "Actinomyces": ["YES", "But weaker"],
    "Akkermansia": ["YES", ""],
    "Alistipes": ["NO", "Certain pairs of species but not at genus level"],
    "Alloprevotella": ["NO", ""],
    "Anaerococcus": ["NO", ""],
    "Anaerostipes": ["YES", ""],
    "Anaerotruncus": ["YES", "- G000403395 (Anaerotruncus sp G3 can co-exist with G000154565 (Anaerotruncus colihominis), but all other pairs of species co-exclude"],
    "Arcanobacterium": ["NO", "(Only 1 species in samples)"],
    "Atopobium": ["YES", ""],
    "Azospirillum": ["NO", "(only 1 species in samples)"],
    "Bacillus": ["YES", ""],
    "Bacteroides": ["NO", ""],
    "Barnesiella": ["NO", ""],
    "Bifidobacterium": ["NO", ""],
    "Blautia": ["NO", ""],
    "Brachyspira": ["YES", ""],
    "Brevibacterium": ["NO", "(???)"],
    "Butyricicoccus": ["NO", ""],
    "Butyricimonas": ["NO", ""],
    "Butyrivibrio": ["YES", ""],
    "Campylobacter": ["YES", ""],
    "Catenibacterium": ["YES", ""],
    "Cellulomonas": ["NO", "(only 1 species in samples)"],
    "Chryseobacterium": ["NO", ""],
    "Citrobacter": ["YES", "(low sample count)"],
    "Cloacibacillus": ["YES", ""],
    "Clostridioides": ["NO", ""],
    "Clostridium": ["NO", ""],
    "Collinsella": ["NO", "(Maybe weakly between certain species pairs)"],
    "Comamonas": ["YES", "ish (Low # samples)"],
    "Coprobacillus": ["YES", ""],
    "Coprococcus": ["NO", ""],
    "Coraliomargarita": ["NO", "(only 1 species in samples)"],
    "Corynebacterium": ["NO", ""],
    "Cryptobacterium": ["NO", "(only 1 species in samples)"],
    "Cutibacterium": ["NO", ""],
    "Desulfovibrio": ["YES", ""],
    "Dialister": ["YES", ""],
    "Dorea": ["NO", ""],
    "Eggerthella": ["NO", ""],
    "Enorma": ["YES", ""],
    "Enterobacter": ["NO", ""],
    "Enterococcus": ["NO", "(Certain species pairs, not all)"],
    "Erysipelatoclostridium": ["NO", ""],
    "Escherichia": ["NO", ""],
    "Eubacterium": ["NO", ""],
    "Facklamia": ["NO", ""],
    "Faecalibacterium": ["NO", ""],
    "Faecalitalea": ["NO", ""],
    "Fibrobacter": ["NO", ""],
    "Fusobacterium": ["YES", ""],
    "Gardnerella": ["NO", ""],
    "Haemophilus": ["YES", ""],
    "Heliobacterium": ["NO", "(only 1 species in samples)"],
    "Holdemania": ["NO", ""],
    "Hungatella": ["NO", "(Weak co-exclusion)"],
    "Intestinimonas": ["NO", ""],
    "Kallipyga": ["NO", "(Low # samples)"],
    "Klebsiella": ["NO", "Co-exclusion of Klebsiella pneumoniae and Klebsiella oxytoca, but co-occurrence of each of these with [Enterobacter] aerogenes or Klebsiella sp. RIT-PI-d.  There looks to be a relative of [Enterobacter] aerogenes that isn’t in the Klebsiella genus in WoL that appears as its own species vector making the data more difficult to understand. "],
    "Kluyvera": ["NO", ""],
    "Lachnoanaerobaculum": ["NO", "(Runs afoul of 500 read count abundance threshold)"],
    "Lachnoclostridium": ["NO", ""],
    "Lactobacillus": ["YES", "(low sample count)"],
    "Lactococcus": ["NO", ""],
    "Lawsonella": ["NO", "(only 1 species in samples)"],
    "Leuconostoc": ["NO", "(low sample count)"],
    "Megamonas": ["YES", "(low sample count)"],
    "Megasphaera": ["YES", ""],
    "Methanobrevibacter": ["YES", ""],
    "Methanomassiliicoccus": ["NO", "(only 1 species in samples)"],
    "Methanosphaera": ["NO", "(only 1 species in samples)"],
    "Mitsuokella": ["NO", "(only 1 species in samples)"],
    "Mycoplasma": ["YES", ""],
    "Odoribacter": ["YES", ""],
    "Oscillibacter": ["NO", ""],
    "Oxalobacter": ["YES", "(low sample count)"],
    "Pantoea": ["NO", "(low sample count)"],
    "Parabacteroides": ["NO", ""],
    "Paraprevotella": ["YES", ""],
    "Parasutterella": ["NO", "(Only 1-2 species in samples, cannot be easily distinguished by metagenomic reads)"],
    "Pediococcus": ["NO", "(low sample count)"],
    "Peptoniphilus": ["NO", ""],
    "Peptostreptococcus": ["NO", ""],
    "Phascolarctobacterium": ["YES", ""],
    "Pontibacillus": ["NO", "(Runs afoil of 500 read count abundance threshold)"],
    "Porphyromonas": ["YES", "(Weakly)"],
    "Prevotella": ["YES", ""],
    "Pseudomonas": ["YES", ""],
    "Rhodospirillum": ["NO", "(only 1 species in samples)"],
    "Riemerella": ["NO", "(only 1 species in samples, runs afoul of 500 read count abundance threshold)"],
    "Roseburia": ["NO", ""],
    "Ruminiclostridium": ["NO", ""],
    "Ruminococcus": ["NO", ""],
    "Sanguibacteroides": ["NO", "(maybe weakly)"],
    "Shigella": ["NO", "(Only 1-2 species in samples, can’t be differentiated by metagenomic reads)"],
    "Slackia": ["YES", ""],
    "Solobacterium": ["YES", ""],
    
    "Staphylococcus": ["YES", ""],
    "Streptococcus": ["YES", ""],
    "Subdoligranulum": ["NO", ""],
    "Succinatimonas": ["YES", ""],
    "Succinivibrio": ["NO", ""],
    "Sulfolobus": ["NO", "(only 1 species in samples)"],
    "Sutterella": ["YES", ""],
    "Synergistes": ["YES", ""],
    "Turicibacter": ["YES", ""],
    "Tyzzerella": ["NO", ""],
    "Varibaculum": ["NO", ""],
    "Veillonella": ["NO", "(maybe certain species pairs)"],
    "Weissella": ["NO", "(Low sample count)"],
    "Yersinia": ["NO", "(Its just a reflection of E.coli and Klebsiella anyway)"],
}